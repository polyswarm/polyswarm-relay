#!/usr/bin/env bash

# Exit script as soon as a command fails.
set -o errexit

# Executes cleanup function at script exit.
trap cleanup EXIT

cleanup() {
  # Kill the testrpc instance that we started (if we started one and if it's still running).
  if [ -n "$testrpc_pid" ] && ps -p $testrpc_pid > /dev/null; then
    kill -9 $testrpc_pid
  fi
}

testrpc_port=8545

start_testrpc() {
  # We define 10 accounts with balance 1M ether, needed for high-value tests.
  local accounts=(
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501200,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501201,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501202,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501203,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501204,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501205,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501206,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501207,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501208,1000000000000000000000000"
    --account="0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501209,1000000000000000000000000"
  )

  ganache-cli --networkId 1337 --gasLimit 0xfffffffffff ${accounts[@]} > /dev/null &

  testrpc_pid=$!
}

start_testrpc

(cd truffle && truffle migrate --reset)
nectar_address=$(jq '.["networks"]["1337"]["address"]' < truffle/build/contracts/NectarToken.json)
bounty_registry_address=$(jq '.["networks"]["1337"]["address"]' < truffle/build/contracts/BountyRegistry.json)
offer_registry_address=$(jq '.["networks"]["1337"]["address"]' < truffle/build/contracts/OfferRegistry.json)

cat > polyswarmd.test.cfg <<- EOF
NECTAR_TOKEN_ADDRESS = $nectar_address
BOUNTY_REGISTRY_ADDRESS = $bounty_registry_address
OFFER_REGISTRY_ADDRESS = $offer_registry_address
EOF

cat polyswarmd.test.cfg

POLYSWARMD_NETWORK=test python3 -m unittest polyswarmd_test $@
